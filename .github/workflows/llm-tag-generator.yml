name:  LLM Tag Generator (Accessory)

on:
  pull_request:
    # Se ejecuta cuando se abre o actualiza un PR hacia la rama 'main'
    branches: ["main"]
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**.md' # Solo si se modifican posts

jobs:
  tag_generation:
    runs-on: ubuntu-latest
    # 隆CRUCIAL! Permite que este workflow escriba de vuelta en el repositorio (haga commit).
    permissions:
      contents: write 
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 es necesario para que la acci贸n de detecci贸n de cambios funcione correctamente
          fetch-depth: 0 

      # 1. Identificar Archivos Modificados
      - name: Get modified files
        id: files
        uses: tj-actions/changed-files@v40
        with:
          files: '_posts/**.md'
          # Asegura que solo se detecten archivos que han cambiado desde el 煤ltimo commit
          since_last_commit: true 

      # 2. Configurar Python y Dependencias
      - name: Set up Python
        # Solo ejecuta si hay archivos .md modificados
        if: steps.files.outputs.modified_files_serialized != '[]' 
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install LLM dependencies
        if: steps.files.outputs.modified_files_serialized != '[]'
        run: |
          python -m pip install --upgrade pip
          # Ruta a la carpeta de scripts
          pip install -r scripts/requirements.txt
          
      # 3. Ejecutar el Script de Generaci贸n de Tags
      - name: Run LLM Tag Generation Script
        if: steps.files.outputs.modified_files_serialized != '[]'
        run: python scripts/generate_llm_tags.py
        env:
          # Inyecta la clave secreta
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Inyecta el primer archivo modificado a Python
          POST_TO_PROCESS: ${{ fromJson(steps.files.outputs.modified_files_serialized)[0] }} 
          
      # 4. Commitear los Cambios Generados por la IA
      - name: Commit generated tags
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # Mensaje claro para el commit automatizado
          commit_message: 'feat: [AI] Added LLM generated tags to post: ${{ fromJson(steps.files.outputs.modified_files_serialized)[0] }}'
          # Solo commitear los archivos Markdown en _posts/ que el script modific贸
          file_pattern: '_posts/**.md' 
          # Configuraci贸n del autor del commit
          commit_user_name: 'AI Tag Generator Bot'
          commit_user_email: 'ai-bot@users.noreply.github.com'
