name: ü§ñ LLM Tag Generator (PR Trigger)

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**.md'

jobs:
  tag_generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    environment: 'github-pages'
    
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }} 
          fetch-depth: 0 

      # 1. Identify Modified Files
      - name: Get modified files
        id: files
        uses: tj-actions/changed-files@v46.0.1
        with:
          files: '_posts/**.md'
          
      # üí• NEW HELPER STEP TO FIX PARSING ERROR (No expression syntax here!)
      - name: Set Post File Path Safely
        id: set_path
        run: |
          # 1. Almacenar la salida en una variable de shell. 
          # Usamos comillas dobles para preservar los espacios si est√°n escapados/entrecomillados, 
          # aunque esto a√∫n no soluciona el problema fundamental del separador.
          INPUT_FILES="${{ steps.files.outputs.added_files }}"
          # 2. Verificar si la lista no est√° vac√≠a.
          if [[ -z "$INPUT_FILES" ]]; then
            echo "No se detectaron archivos nuevos. Marcando para SKIP."
            echo "post_path=SKIP" >> $GITHUB_OUTPUT
          else
            # --- Manejo del primer archivo (asumiendo que los archivos no tienen espacios) ---
            # Si la acci√≥n de origen S√ç separa por espacios, esta es la forma m√°s limpia:
            
            # Lee la variable en un array, usando el espacio como separador (IFS)
            # Esto FALLAR√Å si hay espacios dentro del nombre de archivo sin comillas/escape.
            read -ra FILE_ARRAY <<< "$INPUT_FILES"
            
            # Extrae el primer elemento del array
            POST_PATH="${FILE_ARRAY[0]}"
            
            echo "Primer archivo detectado: $POST_PATH"
            echo "post_path=$POST_PATH" >> $GITHUB_OUTPUT
          fi

      # 2. Setup Python and Dependencies
      - name: Setup Python
        if: steps.set_path.outputs.post_path != 'SKIP' # Use the new path check
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install LLM dependencies
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          
      # 3. Execute the Tag Generation Script
      - name: Run LLM Tag Generation Script
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: python scripts/generate_llm_tags.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Now safely use the output from the helper step
          POST_TO_PROCESS: ${{ steps.set_path.outputs.post_path }} 
          
      # 4. Commit generated changes back to the PR
      - name: Commit merged tags to PR branch
        if: success() && steps.set_path.outputs.post_path != 'SKIP'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: [AI] Merged LLM tags into official tags list.'
          file_pattern: '_posts/**.md'
          branch: ${{ github.event.pull_request.head.ref }} 
          commit_user_name: 'AI Tag Generator Bot'
          commit_user_email: 'ai-bot@users.noreply.github.com'
