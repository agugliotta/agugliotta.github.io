name: ðŸ¤– LLM Tag Generator (PR Trigger)

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**.md'

jobs:
  tag_generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }} 
          fetch-depth: 0 

      # 1. Identify Modified Files
      - name: Get modified files
        id: files
        uses: tj-actions/changed-files@v46.0.1
        with:
          files: '_posts/**.md'
          
      # ðŸ’¥ NEW HELPER STEP TO FIX PARSING ERROR (No expression syntax here!)
      - name: Set Post File Path Safely
        id: set_path
        env:
          MODIFIED_FILES: ${{ steps.files.outputs.modified_files }}
        run: |
          # 1. Check if the 'modified_files' output (space-separated list) is NOT empty.
          #    This is simpler and safer than checking for '[]' or 'null'.
          if [[ "$MODIFIED_FILES" != "" ]]; then
            
            # 2. Extract the first path from the space-separated list using awk
            POST_PATH=$(echo "$MODIFIED_FILES" | awk '{print $1}')
            
            # 3. Set the output variable
            echo "post_path=${POST_PATH}" >> $GITHUB_OUTPUT
          else
            # 4. If the output is empty, set the flag to SKIP
            echo "post_path=SKIP" >> $GITHUB_OUTPUT
          fi

      # 2. Setup Python and Dependencies
      - name: Setup Python
        if: steps.set_path.outputs.post_path != 'SKIP' # Use the new path check
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install LLM dependencies
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          
      # 3. Execute the Tag Generation Script
      - name: Run LLM Tag Generation Script
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: python scripts/generate_llm_tags.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Now safely use the output from the helper step
          POST_TO_PROCESS: ${{ steps.set_path.outputs.post_path }} 
          
      # 4. Commit generated changes back to the PR
      - name: Commit merged tags to PR branch
        if: success() && steps.set_path.outputs.post_path != 'SKIP'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: [AI] Merged LLM tags into official tags list.'
          file_pattern: '_posts/**.md'
          branch: ${{ github.event.pull_request.head.ref }} 
          commit_user_name: 'AI Tag Generator Bot'
          commit_user_email: 'ai-bot@users.noreply.github.com'
