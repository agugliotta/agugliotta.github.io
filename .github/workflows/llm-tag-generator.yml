name: ðŸ¤– LLM Tag Generator (PR Trigger)

on:
  pull_request:
    branches: ["main"]
    types: [opened, synchronize, reopened]
    paths:
      - '_posts/**.md'

jobs:
  tag_generation:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      
    steps:
      - name: Checkout PR Branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }} 
          fetch-depth: 0 

      # 1. Identify Modified Files
      - name: Get modified files
        id: files
        uses: tj-actions/changed-files@v40
        with:
          files: '_posts/**.md'
          since_last_commit: true
          
      # ðŸ’¥ NEW HELPER STEP TO FIX PARSING ERROR
      - name: Set Post File Path Safely
        id: set_path
        # Use shell logic to safely assign the path or 'SKIP'
        run: echo "post_path=$(if [[ "${{ steps.files.outputs.modified_files_serialized }}" != "[]" ]]; then echo "${{ fromJson(steps.files.outputs.modified_files_serialized)[0] }}"; else echo "SKIP"; fi)" >> $GITHUB_OUTPUT

      # 2. Setup Python and Dependencies
      - name: Setup Python
        if: steps.set_path.outputs.post_path != 'SKIP' # Use the new path check
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install LLM dependencies
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt
          
      # 3. Execute the Tag Generation Script
      - name: Run LLM Tag Generation Script
        if: steps.set_path.outputs.post_path != 'SKIP'
        run: python scripts/generate_llm_tags.py
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # Now safely use the output from the helper step
          POST_TO_PROCESS: ${{ steps.set_path.outputs.post_path }} 
          
      # 4. Commit generated changes back to the PR
      - name: Commit merged tags to PR branch
        if: success() && steps.set_path.outputs.post_path != 'SKIP'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'feat: [AI] Merged LLM tags into official tags list.'
          file_pattern: '_posts/**.md'
          branch: ${{ github.event.pull_request.head.ref }} 
          commit_user_name: 'AI Tag Generator Bot'
          commit_user_email: 'ai-bot@users.noreply.github.com'
